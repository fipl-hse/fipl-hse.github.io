<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Лабораторная работа №4. Заполнение текста с помощью n-грамм &mdash; Программирование для лингвистов  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../_static/design-tabs.js?v=36754332"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="lab_4_fill_words_by_ngrams package" href="lab_4_fill_words_by_ngrams.api.html" />
    <link rel="prev" title="lab_3_generate_by_ngrams package" href="../lab_3_generate_by_ngrams/lab_3_generate_by_ngrams.api.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Программирование для лингвистов
              <img src="../../../../_static/fal_logo.jpeg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../useful_docs/index.html">Полезные Материалы</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Курс “Программирование для лингвистов” (2023/2024)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../general_info.html">Общая информация</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Лабораторные работы</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../lab_1_classify_by_unigrams/lab_1.html">Лабораторная работа №1. Определение языка текста на основе частотного словаря</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lab_2_tokenize_by_bpe/lab_2.html">Лабораторная работа №2. Кодирование текста с помощью алгоритма BPE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lab_3_generate_by_ngrams/lab_3.html">Лабораторная работа №3. Генерация текста с помощью n-грамм</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Лабораторная работа №4. Заполнение текста с помощью n-грамм</a><ul>
<li class="toctree-l4"><a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html">lab_4_fill_words_by_ngrams package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../lectures_content_ru.html">Краткий конспект лекций</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../useful_docs/general_docs/index.html">Полезные материалы для курсов на русском языке</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../labs_2024/index.html">Курс “Программирование для лингвистов” (2024/2025)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../labs_2025/index.html">Курс “Программирование для лингвистов” (2025/2026)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ctlr_2023/index.html">Technical Track of Computer Tools for Linguistic Research (2023/2024)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ctlr_2024/index.html">Technical Track of Computer Tools for Linguistic Research (2024/2025)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llm_2023/index.html">Курс “Информационный поиск и извлечение данных” (2023/2024)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llm_2024/index.html">Курс “Информационный поиск и извлечение данных” (2024/2025)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llm_2025/index.html">Курс “Информационный поиск и извлечение данных” (2025/2026)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Программирование для лингвистов</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Курс “Программирование для лингвистов” (2023/2024)</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Лабораторные работы</a></li>
      <li class="breadcrumb-item active">Лабораторная работа №4. Заполнение текста с помощью n-грамм</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/docs/labs_2023/labs/lab_4_fill_words_by_ngrams/lab_4.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="o4-n">
<h1>Лабораторная работа №4. Заполнение текста с помощью n-грамм<a class="headerlink" href="#o4-n" title="Link to this heading"></a></h1>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Full API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html">lab_4_fill_words_by_ngrams package</a></li>
</ul>
</div>
<section id="id1">
<h2>Дано<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Текст на английском языке (<code class="docutils literal notranslate"><span class="pre">assets/Harry_Potter.txt</span></code>),
который загружен и сохранен в переменную <code class="docutils literal notranslate"><span class="pre">text</span></code> в <code class="docutils literal notranslate"><span class="pre">start.py</span></code>.</p></li>
<li><p>Тест на уровень владения английским языком (<code class="docutils literal notranslate"><span class="pre">assets/question_and_answers.json</span></code>).</p></li>
</ol>
<p>Ранее мы рассмотрели несколько способов детерминированной генерации текста с
использованием N-грамм.
Детерминированная генерация текста предсказуема и воспроизводима: при одинаковых
входных данных она всегда дает один и тот же результат.</p>
<p>В настоящей лабораторной работе Вам предстоит
познакомиться с рандомизированным алгоритмом генерации, который кроме всего прочего
генерирует текст по словам, а не по символам.
В отличие от детерминированной, рандомизированная генерация включает случайные
элементы, что делает результаты непредсказуемыми и изменчивыми при каждом запуске.
Детерминированные методы обеспечивают стабильность, подходящую для строгих контрольных
задач. Рандомизированные методы поддерживают творческую вариативность, подходящую для
генерации уникальных идей и контента.</p>
<p>При этом очевидно, что степень случайности
необходимо контролировать: полностью случайный текст не будет
иметь никакого смысла. Для контроля степени рандомизации в данной
работе предлагается использовать технику семплирования
<a class="reference external" href="https://huggingface.co/blog/how-to-generate#top-p-nucleus-sampling">Top P</a>.
Ее идея заключается в том, что при выборе следующего токена
мы ограничиваемся набором наиболее вероятных токенов,
порог вхождения для которых определяется параметром.</p>
<p>Кроме реализации описанного подхода Вам также предстоит сравнить знакомые
Вам техники генерации текста при помощи метрики
<a class="reference external" href="https://huggingface.co/docs/transformers/perplexity">Perplexity</a>.
Простыми словами, данная метрика оценивает необычность сгенерированного текста,
исходя из доступного распределения токенов.</p>
</section>
<section id="id2">
<h2>Что необходимо сделать<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="id3">
<h3>Шаг 0. Начать работу над лабораторной (вместе с преподавателем на практике)<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Измените файлы <code class="docutils literal notranslate"><span class="pre">main.py</span></code> и <code class="docutils literal notranslate"><span class="pre">start.py</span></code>.</p></li>
<li><p>Закоммитьте изменения и создайте новый Pull Request.</p></li>
</ol>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Код, выполняющий все требуемые действия, должен быть написан в
функции <code class="docutils literal notranslate"><span class="pre">main</span></code> в модуле <code class="docutils literal notranslate"><span class="pre">start.py</span></code>.</p>
</div>
<p>Для этого реализуйте функции в модуле <code class="docutils literal notranslate"><span class="pre">main.py</span></code>
и импортируйте их в <code class="docutils literal notranslate"><span class="pre">start.py</span></code>.
Вызов функции в файле <code class="docutils literal notranslate"><span class="pre">start.py</span></code>:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>В рамках данной лабораторной работы <strong>нельзя использовать
сторонние модули, а также стандартные модули collections и itertools</strong>.</p>
<p>Обратите внимание, что в файле <code class="docutils literal notranslate"><span class="pre">target_score.txt</span></code> необходимо выставить
желаемую оценку: 6, 8 или 10. Чем выше желаемая оценка, тем больше
тестов запускается при проверке Вашего Pull Request.</p>
</section>
<section id="id4">
<h3>Шаг 1. Творческое задание (будет анонсировано преподавателем на практике)<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Выполнение Шага 1 соответствует 4 баллам.</p>
</div>
</section>
<section id="id5">
<h3>Шаг 2. Предобработка текста<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p>Традиционно работа с текстом начинается с предобработки.
В рамках предобработки текст очищается, токенизируется и кодируется в числовые
идентификаторы. Это необходимо для оптимизации работы программы: операции над
числами требуют меньшего количества ресурсов, чем операции над строками.</p>
<p>Для предобработки текста необходимо реализовать класс
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.WordProcessor" title="lab_4_fill_words_by_ngrams.main.WordProcessor"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.WordProcessor</span></code></a>.
Данный класс должен наследоваться от
<a class="reference internal" href="../../../labs_2025/labs/lab_3_generate_by_ngrams/lab_3_generate_by_ngrams.api.html#lab_3_generate_by_ngrams.main.TextProcessor" title="lab_3_generate_by_ngrams.main.TextProcessor"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_3_generate_by_ngrams.main.TextProcessor</span></code></a>, поскольку их логика
во многом похожа. Принципиальным отличием выступает используемая единица текста:
в данной лабораторной работе мы будем оперировать словами, а не буквами.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Нет необходимости переопределять логику инициализации экземпляра,
поскольку она наследуется от класса-родителя.</p>
</div>
<p>Пример инициализации экземпляра:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">word_processor</span> <span class="o">=</span> <span class="n">WordProcessor</span><span class="p">(</span><span class="s1">&#39;&lt;eos&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<section id="id6">
<h4>Шаг 2.1. Токенизировать текст<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.WordProcessor._tokenize" title="lab_4_fill_words_by_ngrams.main.WordProcessor._tokenize"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.WordProcessor._tokenize()</span></code></a>,
который позволяет разбить текст на токены.</p>
<p>Поскольку в данной лабораторной токеном выступает слово, а не буква, необходимо
переопределить логику токенизации текста.</p>
<p>В ходе выполнения данного метода знаки препинания, обозначающие конец предложения
(<code class="docutils literal notranslate"><span class="pre">!</span></code>, <code class="docutils literal notranslate"><span class="pre">?</span></code>, <code class="docutils literal notranslate"><span class="pre">.</span></code>), должны быть заменены на специальный токен конца предложения.
Обратите внимание, что токен конца предложения содержится в соответствующем атрибуте,
унаследованном от класса
<a class="reference internal" href="../../../labs_2025/labs/lab_3_generate_by_ngrams/lab_3_generate_by_ngrams.api.html#lab_3_generate_by_ngrams.main.TextProcessor" title="lab_3_generate_by_ngrams.main.TextProcessor"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_3_generate_by_ngrams.main.TextProcessor</span></code></a>.
Далее текст необходимо очистить от цифр и специальных символов, оставив только
пробелы, буквы и токены конца предложения. Текст необходимо привести
к нижнему регистру и разделить на слова. Границей слова в настоящей лабораторной
выступает пробел либо сочетание пробельных символов. Обратите внимание, что токен
конца предложения является отдельным токеном и не примыкает к
последнему слову предложения.</p>
<p>Например, строка <code class="docutils literal notranslate"><span class="pre">'She</span> <span class="pre">is</span> <span class="pre">happy.</span> <span class="pre">He</span> <span class="pre">is</span> <span class="pre">happy.'</span></code> должна быть
токенизирована следующим образом:
<code class="docutils literal notranslate"><span class="pre">('she',</span> <span class="pre">'is',</span> <span class="pre">'happy',</span> <span class="pre">'&lt;eos&gt;',</span> <span class="pre">'he',</span> <span class="pre">'is',</span> <span class="pre">'happy',</span> <span class="pre">'&lt;eos&gt;')</span></code>,
где <code class="docutils literal notranslate"><span class="pre">'&lt;eos&gt;'</span></code> - специальный токен конца предложения</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если на вход подается аргумент неправильного типа, то есть не
строка, или строка пустая, то необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Данный метод является защищенным - его использование за пределами
методов класса не предполагается.</p>
</div>
</section>
<section id="id7">
<h4>Шаг 2.2. Добавить токен в хранилище<a class="headerlink" href="#id7" title="Link to this heading"></a></h4>
<p>Нам также необходимо заполнить внутреннее хранилище токенами переданной
последовательности. Так как в данной лабораторной мы оперируем словами, а не
буквами, требования к токенам отличаются. Поэтому метод добавления токена
в хранилище необходимо переопределить.</p>
<p>На этом шаге Вам нужно присвоить токену
некоторый уникальный целочисленный идентификатор.
Для этого реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.WordProcessor._put" title="lab_4_fill_words_by_ngrams.main.WordProcessor._put"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.WordProcessor._put()</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Идентификатор</strong> - значение, которое однозначно указывает
на токен и равно длине <code class="docutils literal notranslate"><span class="pre">_storage</span></code> (атрибут объекта данного
класса) на момент добавления буквы. Идентификатор специального
символа конца предложения принимает значение <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</div>
<p><strong>Правила корректного заполнения хранилища</strong>:</p>
<ul class="simple">
<li><p>Идентификаторы уникальны и однозначно указывают на токен (например, при добавлении
нового токена можно использовать длину хранилища <code class="docutils literal notranslate"><span class="pre">_storage</span></code>);</p></li>
<li><p>Для одного токена существует ровно один идентификатор;</p></li>
<li><p>Одинаковых идентификаторов у двух разных токенов быть не может;</p></li>
<li><p>Если токен уже был добавлен в хранилище, идентификатор остается прежним;</p></li>
<li><p>Идентификатор специального токена конца слова должен принимать значение <cite>0</cite>. Обратите
внимание, что выполнение данного условия гарантируется логикой инициализации экземпляра.</p></li>
</ul>
<p>Например, если на вход подается токен <code class="docutils literal notranslate"><span class="pre">'she'</span></code>, то хранилище будет
выглядеть следующим образом - <code class="docutils literal notranslate"><span class="pre">{'&lt;eow&gt;':</span> <span class="pre">0,</span> <span class="pre">'she':</span> <span class="pre">1}</span></code>, где <code class="docutils literal notranslate"><span class="pre">'&lt;eow&gt;'</span></code> - токен
конца предложения.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если на вход подается некорректное значение (аргумент
неправильного типа, то есть не строка, или пустая строка),
то необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Данный метод является защищенным - его использование за пределами
методов класса не предполагается.</p>
</div>
</section>
<section id="id8">
<h4>Шаг 2.3. Постобработать текст<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p>Методы получения идентификатора по токену и токена по идентификатору, а также
методы кодирования и декодирования текста переопределять не нужно: их логика
остается актуальной и для обработки текста по словам.
Именно в этом заключается удобство использования наследования при разработке программы.
Таким образом, нам остается переопределить только постобработку текста.</p>
<p>Для этого необходимо реализовать метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.WordProcessor._postprocess_decoded_text" title="lab_4_fill_words_by_ngrams.main.WordProcessor._postprocess_decoded_text"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.WordProcessor._postprocess_decoded_text()</span></code></a>,
который позволяет перейти от токенизированного текста в формате
кортежа к тексту в строковом формате.</p>
<p>При этом на выходе строка должна соответствовать следующим требованиям:</p>
<ol class="arabic simple">
<li><p>Каждое предложение должно начинаться с заглавной буквы.</p></li>
<li><p>В итоговом тексте не должно быть нескольких пробелов подряд.</p></li>
<li><p>Текст должен заканчиваться точкой.</p></li>
</ol>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Специальные токены конца предложения должны быть
конвертированы в точки.</p>
</div>
<p>Например, для декодированного корпуса
<code class="docutils literal notranslate"><span class="pre">('she',</span> <span class="pre">'is',</span> <span class="pre">'happy',</span> <span class="pre">'&lt;eos&gt;',</span> <span class="pre">'he',</span> <span class="pre">'is',</span> <span class="pre">'happy',</span> <span class="pre">'&lt;eos&gt;')</span></code>
должен получиться следующий текст: <code class="docutils literal notranslate"><span class="pre">She</span> <span class="pre">is</span> <span class="pre">happy.</span> <span class="pre">He</span> <span class="pre">is</span> <span class="pre">happy.</span></code>,
где <code class="docutils literal notranslate"><span class="pre">'&lt;eow&gt;'</span></code> - токен конца предложения.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если на вход подаются некорректные значения (токенизированный
текст не является кортежем или кортеж пустой),
то необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Данный метод является защищенным - его использование за пределами
методов класса не предполагается.</p>
</div>
</section>
</section>
<section id="id9">
<h3>Шаг 3. Рандомизированная генерация текста<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<p>Для аппроксимации вероятностного распределения токенов в зависимости
от контекста мы вновь будем опираться на понятие N-граммы.
В этом нам пригодится языковая модель, реализованная в предыдущей
лабораторной работе,
<a class="reference internal" href="../../../labs_2025/labs/lab_3_generate_by_ngrams/lab_3_generate_by_ngrams.api.html#lab_3_generate_by_ngrams.main.NGramLanguageModel" title="lab_3_generate_by_ngrams.main.NGramLanguageModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_3_generate_by_ngrams.main.NGramLanguageModel</span></code></a>.</p>
<p>Обратите внимание, что ее логика остается актуальной и для задачи недетерминированной
генерации, поэтому переопределять сущность языковой модели нет необходимости.
Для использования данного класса в текущей лабораторной достаточно его импортировать.</p>
<p>Как уже упоминалось, для рандомизации генерации текста мы будем использовать
технику <strong>Top P</strong>. В данном случае <strong>P</strong> - это порог суммарной вероятности, который
определяет количество вариантов генерации.</p>
<p>Пусть <span class="math notranslate nohighlight">\(w_{1}, w_{2}, ..., w_{n}\)</span> - список токенов, отсортированных таким
образом, что <span class="math notranslate nohighlight">\(p(w_{1}|context) &gt; p(w_{2}|context) &gt; ... &gt; p(w_{n}|context)\)</span>,
где <span class="math notranslate nohighlight">\(p(w_{i}|context)\)</span> -
вероятность появления токена <span class="math notranslate nohighlight">\(w_{i}\)</span> в контексте <span class="math notranslate nohighlight">\(context\)</span>,
<span class="math notranslate nohighlight">\(n\)</span> - количество кандидатов для продолжения последовательности.</p>
<p>Тогда в рамках <strong>Top P</strong> подхода случайный выбор следующего токена будет происходить
из таких первых <span class="math notranslate nohighlight">\(N\)</span> токенов, чтобы удовлетворялись оба условия:</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(\sum_{i=1}^{N}p(w_{i}|context) \geq P\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\sum_{i=1}^{N - 1}p(w_{i}|context) &lt; P\)</span></p></li>
</ol>
<p>Иными словами, мы хотим выбрать минимальное количество токенов,
которыми можем превысить заданный порог.
Таким образом, если для какого-то контекста существуют варианты продолжения
с очень высокой вероятностью, выбор будет производиться среди меньшего количества
вариантов. В противном случае, если доступные варианты продолжения последовательности
имеют низкую вероятность, выбор слова будет производиться из большего количества
вариантов. Это позволяет избегать генерации слишком неправдоподобной
последовательности, при этом не делая ее полностью детерминированной.</p>
<p>Рассмотрим пример.
Допустим, нам даны следующие варианты продолжения последовательности:
<code class="docutils literal notranslate"><span class="pre">{'she':</span> <span class="pre">0.46,</span> <span class="pre">'that':</span> <span class="pre">0.2,</span> <span class="pre">'&lt;eos&gt;':</span> <span class="pre">0.04,</span> <span class="pre">'cat':</span> <span class="pre">0.01,</span> <span class="pre">'is':</span> <span class="pre">0.33}</span></code>.
Отсортируем токены по их вероятности в порядке убывания:
<code class="docutils literal notranslate"><span class="pre">['she',</span> <span class="pre">'is',</span> <span class="pre">'that',</span> <span class="pre">'&lt;eos&gt;',</span> <span class="pre">'cat']</span></code>.
Пусть порогом суммарной вероятности <strong>P</strong> является значение <code class="docutils literal notranslate"><span class="pre">0.8</span></code>, тогда
случайный выбор следующего токена будет производиться из набора токенов
<code class="docutils literal notranslate"><span class="pre">[she',</span> <span class="pre">'is',</span> <span class="pre">'that]</span></code>, так как их суммарная вероятность равна <code class="docutils literal notranslate"><span class="pre">0.97</span></code>, что превышает
порога <code class="docutils literal notranslate"><span class="pre">0.8</span></code>, и исключение последнего рассматриваемого токена <code class="docutils literal notranslate"><span class="pre">'that'</span></code> снизит
сумму вероятности ниже порога.</p>
<section id="id10">
<h4>Шаг 3.1. Объявить сущность генератора<a class="headerlink" href="#id10" title="Link to this heading"></a></h4>
<p>Для генерации текста описанным способом вам необходимо реализовать
класс <a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.TopPGenerator" title="lab_4_fill_words_by_ngrams.main.TopPGenerator"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.TopPGenerator</span></code></a>.</p>
<p>Данный класс заключает в себе полную логику продолжения последовательности
от принятия исходного контекста до постобработки результата.</p>
<p>С интерфейсом инициализации экземпляра данного класса, а также с составом
требуемых атрибутов можно ознакомиться в соответствующей строке документации
в файле <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p>
<p>Пример инициализации экземпляра:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">top_p_generator</span> <span class="o">=</span> <span class="n">TopPGenerator</span><span class="p">(</span><span class="n">language_model</span><span class="p">,</span> <span class="n">word_processor</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id11">
<h4>Шаг 3.2. Сгенерировать последовательность<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.TopPGenerator.run" title="lab_4_fill_words_by_ngrams.main.TopPGenerator.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.TopPGenerator.run()</span></code></a>,
который генерирует последовательность указанной длины по заданному контексту.</p>
<p>Прежде чем приступить к генерации, необходимо предобработать заданное
начало последовательности. Для этого используйте экземпляр
класса <code class="docutils literal notranslate"><span class="pre">WordProcessor</span></code>, который хранится в соответствующем атрибуте.</p>
<p>В ходе генерации необходимо предпринять следующие шаги:</p>
<ol class="arabic simple">
<li><p>Закодировать исходную последовательности. Используйте для этого экземпляр класса
<code class="docutils literal notranslate"><span class="pre">WordProcessor</span></code>.</p></li>
<li><p>Получить возможные токены для продолжения последовательности. Используйте
для этого экземпляр класса <code class="docutils literal notranslate"><span class="pre">NGramLanguageModel</span></code>.</p></li>
<li><p>Выявить <strong>N</strong> минимальное количество наиболее вероятных токенов, чья суммарная
последовательность превышает заданный <strong>P</strong> или равна ему. Для получения
наиболее вероятных токенов отсортируйте токены-кандидаты в порядке убывания их
вероятностей. В случае, если несколько токенов имеют одинаковую вероятность,
то выбор нужно делать на основе значений ключей, которые сортируются в порядке убывания.</p></li>
<li><p>Случайным образом выбрать один из <strong>N</strong> токенов, отобранных на предыдущем шаге,
использовать его для продолжения последовательности.</p></li>
<li><p>Повторить шаги 1-3 до тех пор, пока не будет достигнута требуемая длина
последовательности.</p></li>
<li><p>Декодировать полученную последовательность. Используйте для этого экземпляр класса
<code class="docutils literal notranslate"><span class="pre">WordProcessor</span></code>.</p></li>
</ol>
<p>Для реализации случайного выбора обратитесь к встроенной библиотеке <code class="docutils literal notranslate"><span class="pre">random</span></code>, а
конкретно к методу <code class="docutils literal notranslate"><span class="pre">choice</span></code>
(<a class="reference external" href="https://docs-python.ru/standart-library/modul-random-python/">документация</a>).</p>
<p>Следует учесть, что:</p>
<ol class="arabic simple">
<li><p>В случае, если кандидаты не были найдены, генерация прекращается.</p></li>
<li><p>С добавлением нового токена к исходной последовательности
контекст изменяется.</p></li>
</ol>
<p>Метод возвращает сгенерированный текст в виде строки, для этого его необходимо
декодировать, используя экземпляр <code class="docutils literal notranslate"><span class="pre">WordProcessor</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если на вход подаются некорректные значения (длина последовательности
не является целым положительным числом,
заданная последовательность не является
строкой или последовательность пустая) или вызываемые методы возвращают
значение <code class="docutils literal notranslate"><span class="pre">None</span></code>, то необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
<p>Обратите внимание, что все реализуемые Вами алгоритмы генерации текста используют
одинаковый набор публичных методов. Это пример полиморфизма.
Полиморфизм в объектно-ориентированном программировании (ООП) — это способность объектов разных
типов использовать одинаковые имена (например, методы или операторы), но выполнять разные действия
в зависимости от своего конкретного типа.</p>
</section>
<section id="start-py">
<h4>Шаг 3.3. Продемонстрировать работу реализации в <code class="docutils literal notranslate"><span class="pre">start.py</span></code><a class="headerlink" href="#start-py" title="Link to this heading"></a></h4>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Выполнение Шага 3 соответствует 6 баллам.</p>
</div>
<p>Продемонстрируйте результат работы рандомизированного алгоритма генерации текста
в функции <code class="docutils literal notranslate"><span class="pre">main()</span></code> модуля <code class="docutils literal notranslate"><span class="pre">start.py</span></code>.
Попробуйте в качестве исходной последовательности использовать <code class="docutils literal notranslate"><span class="pre">'Vernon'</span></code>.
Пусть размер n-грамм будет равен 2, длина последовательности - 51,
а значение <strong>P</strong> - 0.5.</p>
</section>
</section>
<section id="id12">
<h3>Шаг 4. Оценка качества сгенерированной последовательности<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>Для оценки вероятности мы будем использовать метрику
<a class="reference external" href="https://huggingface.co/docs/transformers/perplexity">Perplexity</a>.
<strong>Перплексия</strong> - это метрика, используемая для измерения качества работы
моделей генерации текста. Она представляет собой обратную вероятность
наблюдения конкретной последовательности слов, сгенерированных моделью.
Таким образом, более низкая перплексия указывает на то, что модель более
уверенно и точно предсказывает следующее слово в последовательности.</p>
<p>Перплексия вычисляется как экспонента от числа,
противоположного усредненной сумме логарифмированных вероятностей
появления каждого из токенов:</p>
<div class="math notranslate nohighlight">
\[e ^{- \frac{1}{n} \sum_{i=1}^{n}\ln p(w_{i}|context_{i})}\]</div>
<p>Здесь <span class="math notranslate nohighlight">\(n\)</span> - количество токенов в оцениваемой последовательности,
<span class="math notranslate nohighlight">\(w_{i}\)</span> - <cite>i</cite>-й токен последовательности, <span class="math notranslate nohighlight">\(context_{i}\)</span> - контекст <cite>i</cite>-го
токена последовательности, <span class="math notranslate nohighlight">\(p(w_{i}|context_{i})\)</span> - вероятность
появления токена <span class="math notranslate nohighlight">\(w_{i}\)</span> в данном контексте <span class="math notranslate nohighlight">\(context_{i}\)</span>.</p>
<p>Рассмотрим пояснение этой формулы.
Вообще, кумулятивную вероятность последовательности можно представить
в качестве сложной вероятности, то есть вероятности совпадения независимых событий,
что подразумевает перемножение вероятностей. Поскольку в данном случае мы работаем
с числами в диапазоне от нуля до единицы, при перемножении большого количества таких чисел
вырастает риск столкнуться с проблемой потери значимости: слишком близкое к нулю
число может стать неотличимо от нуля для программы. Поэтому мы логарифмируем вероятность,
тем самым увеличивая ее порядок. Логарифм также позволяет нам перейти от
перемножения к сумме. Однако логарифмирование инвертирует порядок, поэтому
необходимо добавить минус. Наконец, возводя число <strong>е</strong> в степень получившегося
значения, мы масштабируем значение метрики таким образом, чтобы любые отклонения
от ожидаемого распределения были более значимыми.</p>
<p>Нередко перплексия оказывается наименьшей для жадных алгоритмов генерации текста
в силу детерминированности и предсказуемости порождаемых последовательностей.
Рандомизированные и нежадные алгоритмы в свою очередь
допускают выбор не самых вероятных токенов
на каждом из шагов продолжения последовательности, иными словами такие алгоритмы
имеют меньше уверенности в той последовательности, которую они порождают.
Это также отражается в значении метрики перплексии.</p>
<section id="id13">
<h4>Шаг 4.1. Реализовать сущность, обозначающую тип генерации<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<p>В настоящей лабораторной работе мы будем сравнивать следующие виды генерации:</p>
<ul class="simple">
<li><p>жадный алгоритм</p></li>
<li><p>алгоритм <strong>Beam Search</strong></p></li>
<li><p>алгоритм <strong>Top P</strong></p></li>
</ul>
<p>Необходимо объявить сущность, хранящую данные виды генерации в качестве атрибутов,
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GeneratorTypes" title="lab_4_fill_words_by_ngrams.main.GeneratorTypes"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GeneratorTypes</span></code></a>.
Это необходимо для предотвращения уязвимости кода в дальнейшем: при передаче аргументов
в виде строки всегда есть вероятность допустить опечатку. Поэтому удобно
иметь класс, экземпляры которого содержат фиксированную репрезентацию того
или иного типа.</p>
<p>Атрибуты экземпляров данного класса должны иметь следующие целочисленные значения:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> для жадного алгоритма;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> для <strong>Top P</strong> алгоритма;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code> для <strong>Beam Search</strong> алгоритма.</p></li>
</ul>
<p>С интерфейсом инициализации экземпляра данного класса, а также с составом
требуемых атрибутов можно ознакомиться в соответствующей строке документации
в файле <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p>
<p>Пример инициализации экземпляра:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">generators_types</span> <span class="o">=</span> <span class="n">GeneratorTypes</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id14">
<h4>Шаг 4.2. Получить название алгоритма генерации<a class="headerlink" href="#id14" title="Link to this heading"></a></h4>
<p>Присвоение целочисленных идентификаторов каждому из типов генерации удобно
для унификации и упрощения операции сравнения, однако строковый формат является более
понятным человеку.</p>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GeneratorTypes.get_conversion_generator_type" title="lab_4_fill_words_by_ngrams.main.GeneratorTypes.get_conversion_generator_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GeneratorTypes.get_conversion_generator_type()</span></code></a>,
который возвращает название метода генерации в виде строки.</p>
<p>Если был использован жадный алгоритм, то следует вернуть строку <code class="docutils literal notranslate"><span class="pre">'Greedy</span> <span class="pre">Generator'</span></code>,
если <strong>Top P</strong> алгоритм - <code class="docutils literal notranslate"><span class="pre">'Top-P</span> <span class="pre">Generator'</span></code>,
если <strong>Beam Search</strong> алгоритм - <code class="docutils literal notranslate"><span class="pre">'Beam</span> <span class="pre">Search</span> <span class="pre">Generator'</span></code>.</p>
</section>
<section id="id15">
<h4>Шаг 4.3. Сохранить оценку генерации текста<a class="headerlink" href="#id15" title="Link to this heading"></a></h4>
<p>Для более удобного управления результатами сравнительного анализа реализуем
сущность, хранящую в себе необходимую информацию о результатах оценки сгенерированной
последовательности,
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GenerationResultDTO" title="lab_4_fill_words_by_ngrams.main.GenerationResultDTO"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GenerationResultDTO</span></code></a>.</p>
<p><a class="reference external" href="https://www.baeldung.com/java-dto-pattern">DTO (Data Transfer Object)</a>
в объектно-ориентированном программировании (ООП)
является шаблоном проектирования, который используется для передачи данных
между слоями программы.</p>
<p>С интерфейсом инициализации экземпляра данного класса, а также с составом
требуемых атрибутов можно ознакомиться в соответствующей строке документации
в файле <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p>
<p>Пример инициализации экземпляра:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">estimation_result</span> <span class="o">=</span> <span class="n">GenerationResultDTO</span><span class="p">(</span><span class="n">generated_text</span><span class="p">,</span> <span class="n">perplexity</span><span class="p">,</span> <span class="n">generator_type</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id16">
<h4>Шаг 4.4. Получить значение метрики качества<a class="headerlink" href="#id16" title="Link to this heading"></a></h4>
<p>Атрибут, хранящий в себе значение метрики перплексии является приватным: мы не предполагаем
его изменения в течение жизненного цикла экземпляра класса <code class="docutils literal notranslate"><span class="pre">GenerationResultDTO</span></code>.</p>
<p>Тем не менее, потребность узнать данное значение существует. Для этого реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_perplexity" title="lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_perplexity"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_perplexity()</span></code></a>,
который возвращает значение перплексии.</p>
</section>
<section id="id17">
<h4>Шаг 4.5. Получить оцениваемую последовательность<a class="headerlink" href="#id17" title="Link to this heading"></a></h4>
<p>Атрибут, хранящий в себе текст, по которому было рассчитано
значение метрики перплексии, является приватным: мы не предполагаем
его изменения в течение жизненного цикла экземпляра класса <code class="docutils literal notranslate"><span class="pre">GenerationResultDTO</span></code>.</p>
<p>Тем не менее, потребность узнать данное значение существует. Для этого реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_text" title="lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_text"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_text()</span></code></a>,
который возвращает текст.</p>
</section>
<section id="id18">
<h4>Шаг 4.6. Получить идентификатор типа алгоритма генерации<a class="headerlink" href="#id18" title="Link to this heading"></a></h4>
<p>Атрибут, хранящий в себе указатель на алгоритм генерации
является приватным: мы не предполагаем
его изменения в течение жизненного цикла экземпляра класса <code class="docutils literal notranslate"><span class="pre">GenerationResultDTO</span></code>.</p>
<p>Тем не менее, потребность узнать данное значение существует. Для этого реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_type" title="lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GenerationResultDTO.get_type()</span></code></a>,
который возвращает идентификатор алгоритма генерации.</p>
</section>
<section id="id19">
<h4>Шаг 4.7. Получить отчет об оценке качества генерации<a class="headerlink" href="#id19" title="Link to this heading"></a></h4>
<p>Наконец, необходимо реализовать формирование отчета о полученном результате.</p>
<p>Для этого реализуйте магический метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GenerationResultDTO.__str__" title="lab_4_fill_words_by_ngrams.main.GenerationResultDTO.__str__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GenerationResultDTO.__str__()</span></code></a>,
который возвращает строку определенного формата, отражающую тип генерации, значение перплексии
и текст, на котором была произведена оценка.</p>
<p>В рамках этого метода необходимо инициализировать экземпляр <code class="docutils literal notranslate"><span class="pre">GeneratorTypes</span></code> и обратиться
к его соответствующему методу.</p>
<p>Метод <code class="docutils literal notranslate"><span class="pre">__str__</span></code> называют магическим, потому что его переопределение меняет поведение
объекта в случае, когда его конвертируют в строку. Это можно проверить, например, вызвав
<code class="docutils literal notranslate"><span class="pre">print</span></code>, передав экземпляр в качестве аргумента.</p>
<p>Рассмотрим пример. Допустим, экземпляр был инициализирован следующим образом:
<code class="docutils literal notranslate"><span class="pre">estimation_result</span> <span class="pre">=</span> <span class="pre">GenerationResultDTO('I</span> <span class="pre">love</span> <span class="pre">apple</span> <span class="pre">juice',</span> <span class="pre">1.2,</span> <span class="pre">1)</span></code>.
Тогда вызов <code class="docutils literal notranslate"><span class="pre">print(estimation_result)</span></code> должен вывести в консоль следующую строку:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">Perplexity</span> <span class="n">score</span><span class="p">:</span> <span class="mf">1.2</span>
<span class="n">Top</span><span class="o">-</span><span class="n">P</span> <span class="n">Generator</span>
<span class="n">Text</span><span class="p">:</span> <span class="n">I</span> <span class="n">love</span> <span class="n">apple</span> <span class="n">juice</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id20">
<h4>Шаг 4.8. Объявить сущность для оценки сгенерированного текста<a class="headerlink" href="#id20" title="Link to this heading"></a></h4>
<p>Наконец, перейдем к реализации класса, ответственного за проведение
сравнительного анализа,
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.QualityChecker" title="lab_4_fill_words_by_ngrams.main.QualityChecker"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.QualityChecker</span></code></a>.</p>
<p>Данный класс заключает логику генерации последовательности каждым из заданных
алгоритмов, подсчет метрики качества для каждой из получившихся последовательностей
и обработку результатов.</p>
<p>С интерфейсом инициализации экземпляра данного класса, а также с составом
требуемых атрибутов можно ознакомиться в соответствующей строке документации
в файле <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p>
<p>Пример инициализации экземпляра:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">generators_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">generators_types</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span> <span class="n">GreedyTextGenerator</span><span class="p">(</span><span class="n">language_model</span><span class="p">,</span> <span class="n">word_processor</span><span class="p">),</span>
    <span class="n">generators_types</span><span class="o">.</span><span class="n">top_p</span><span class="p">:</span> <span class="n">TopPGenerator</span><span class="p">(</span><span class="n">language_model</span><span class="p">,</span> <span class="n">word_processor</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">generators_types</span><span class="o">.</span><span class="n">beam_search</span><span class="p">:</span> <span class="n">BeamSearchTextGenerator</span><span class="p">(</span><span class="n">language_model</span><span class="p">,</span> <span class="n">word_processor</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">checker</span> <span class="o">=</span> <span class="n">QualityChecker</span><span class="p">(</span><span class="n">generators_dict</span><span class="p">,</span> <span class="n">language_model</span><span class="p">,</span> <span class="n">word_processor</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id21">
<h4>Шаг 4.9. Посчитать метрику качества последовательности<a class="headerlink" href="#id21" title="Link to this heading"></a></h4>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.QualityChecker._calculate_perplexity" title="lab_4_fill_words_by_ngrams.main.QualityChecker._calculate_perplexity"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.QualityChecker._calculate_perplexity()</span></code></a>.</p>
<p>Метод производит оценку сгенерированной последовательности следующим образом:</p>
<ol class="arabic simple">
<li><p>Для этого в первую очередь необходимо закодировать последовательность.
Используйте для этого экземпляр класса <code class="docutils literal notranslate"><span class="pre">WordProcessor</span></code>.</p></li>
<li><p>Далее для каждого из токенов последовательности необходимо получить вероятность
его появления в данном контексте, используя экземпляр языковой модели.</p></li>
<li><p>Полученные вероятности необходимо использовать для подсчета <cite>Perplexity</cite> по формуле
перплексии:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[e ^{- \frac{1}{n} \sum_{i=1}^{n}\ln p(w_{i}|context_{i})}\]</div>
<p>Здесь <span class="math notranslate nohighlight">\(n\)</span> - количество токенов в оцениваемой последовательности,
<span class="math notranslate nohighlight">\(w_{i}\)</span> - <cite>i</cite>-й токен последовательности, <span class="math notranslate nohighlight">\(context_{i}\)</span> - контекст <cite>i</cite>-го
токена последовательности, <span class="math notranslate nohighlight">\(p(w_{i}|context_{i})\)</span> - вероятность
появления токена <span class="math notranslate nohighlight">\(w_{i}\)</span> в данном контексте <span class="math notranslate nohighlight">\(context_{i}\)</span>.
Подробное рассмотрение формулы приведено выше.</p>
<p>Рассмотрим пример.
Допустим, мы имеем следующие данные о вероятности появления биграмм:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="mf">1.0</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Давайте оценим качество следующей сгенерированной последовательности:
<code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">2,</span> <span class="pre">3)</span></code>.</p>
<p>Подсчитаем логарифм вероятности для каждого из токенов в данной последовательности, за
исключением последнего токена конца предложения: для токена 2 логарифм вероятности
составляет <code class="docutils literal notranslate"><span class="pre">-0.6931471805599453</span></code>, для токена 3 логарифм вероятности составляет <code class="docutils literal notranslate"><span class="pre">0.0</span></code>.</p>
<p>Таким образом, сумма логарифмов вероятности равна <code class="docutils literal notranslate"><span class="pre">-0.6931471805599453</span></code>.
Усредним и инвертируем: <code class="docutils literal notranslate"><span class="pre">0.34657359027997264</span></code>. Значением метрики будет являться
экспонента от этого числа, то есть <code class="docutils literal notranslate"><span class="pre">1.414213562373095</span></code>.</p>
<p>Для подсчета логарифма воспользуйтесь встроенным модулем <code class="docutils literal notranslate"><span class="pre">math</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если аргументы имеют некорректный тип данных, то есть не
являются строкой, или строка пустая,
а также если вызываемые методы
возвращают <code class="docutils literal notranslate"><span class="pre">None</span></code>, необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
</section>
<section id="id22">
<h4>Шаг 4.10. Реализовать логику сравнительного анализа<a class="headerlink" href="#id22" title="Link to this heading"></a></h4>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.QualityChecker.run" title="lab_4_fill_words_by_ngrams.main.QualityChecker.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.QualityChecker.run()</span></code></a>,
осуществляющий логику сравнительного анализа.</p>
<p>Для каждого из методов генерации, хранимых в соответствующем атрибуте,
необходимо сгенерировать последовательность
заданной длины по заданному контексту. Полученные последовательности необходимо оценить
при помощи метода
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.QualityChecker._calculate_perplexity" title="lab_4_fill_words_by_ngrams.main.QualityChecker._calculate_perplexity"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.QualityChecker._calculate_perplexity()</span></code></a>.
Результат оценки необходимо сохранить в экземпляр
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GenerationResultDTO" title="lab_4_fill_words_by_ngrams.main.GenerationResultDTO"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GenerationResultDTO</span></code></a>.
Каждому методу генерации должен соответствовать один экземпляр хранилища результатов.
Возвращаемые значения должны быть отсортированы по значению метрики в порядке
возрастания. В случае, если значения метрики совпадают, необходимо дополнительно
отсортировать по целочисленному идентификатору типа алгоритма.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если входные аргументы имеют неправильный тип, входная последовательность
является пустой строкой или требуемая длина не является положительным
числом, а также если вызываемые методы возвращают <code class="docutils literal notranslate"><span class="pre">None</span></code>,
необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
</section>
<section id="id23">
<h4>Шаг 4.11. Продемонстрировать работу реализации в <code class="docutils literal notranslate"><span class="pre">start.py</span></code><a class="headerlink" href="#id23" title="Link to this heading"></a></h4>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Выполнение Шага 4 соответствует 8 баллам.</p>
</div>
<p>Продемонстрируйте результат сравнительного анализа
в функции <code class="docutils literal notranslate"><span class="pre">main()</span></code> модуля <code class="docutils literal notranslate"><span class="pre">start.py</span></code>. В качестве аргумента для
инициализации экземпляра класса
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.QualityChecker" title="lab_4_fill_words_by_ngrams.main.QualityChecker"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.QualityChecker</span></code></a>
необходимо использовать экземпляр класса
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GeneratorTypes" title="lab_4_fill_words_by_ngrams.main.GeneratorTypes"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GeneratorTypes</span></code></a>.</p>
<p>Сравните качество генерации алгоритмами жадной генерации, <strong>Beam Search</strong> генерации
и <strong>Top P</strong> генерации.</p>
<p>Для <strong>Top P</strong> алгоритма качестве значения <strong>P</strong> используйте <code class="docutils literal notranslate"><span class="pre">0.5</span></code>,
в качестве параметра ширины луча для алгоритма <strong>Beam Search</strong>
используйте <code class="docutils literal notranslate"><span class="pre">5</span></code>. Начните генерацию со строки <code class="docutils literal notranslate"><span class="pre">'The'</span></code>,
при сравнительном анализе используйте длину последовательности <code class="docutils literal notranslate"><span class="pre">100</span></code>.</p>
</section>
</section>
<section id="id24">
<h3>Шаг 5. Симуляция проведения экзамена на знание языка<a class="headerlink" href="#id24" title="Link to this heading"></a></h3>
<p>В данном шаге предлагается в игровой форме оценить способность изученных алгоритмов
генерации корректно дополнять текст пропущенными словами.
Частым заданием в тестах на выявление уровня владением языком является вставка
пропущенного слова. Давайте реализуем проведение такого экзамена.</p>
<p>Например, задание может выглядеть следующим образом:</p>
<ul class="simple">
<li><p>текст, который необходимо дополнить:
<code class="docutils literal notranslate"><span class="pre">Frosty</span> <span class="pre">the</span> <span class="pre">Snowman</span> <span class="pre">was</span> <span class="pre">made</span> <span class="pre">of</span> <span class="pre">and</span> <span class="pre">had</span> <span class="pre">a</span> <span class="pre">corncob</span> <span class="pre">pipe</span> <span class="pre">and</span> <span class="pre">a</span> <span class="pre">button</span> <span class="pre">nose.</span></code>;</p></li>
<li><p>позиция, на которую необходимо вставить слово: <code class="docutils literal notranslate"><span class="pre">30</span></code>;</p></li>
<li><p>ответ: <code class="docutils literal notranslate"><span class="pre">Frosty</span> <span class="pre">the</span> <span class="pre">Snowman</span> <span class="pre">was</span> <span class="pre">made</span> <span class="pre">of</span> <span class="pre">snow</span> <span class="pre">and</span> <span class="pre">had</span> <span class="pre">a</span> <span class="pre">corncob</span> <span class="pre">pipe</span> <span class="pre">and</span> <span class="pre">a</span> <span class="pre">button</span> <span class="pre">nose.</span></code>.</p></li>
</ul>
<section id="id25">
<h4>Шаг 5.1. Объявить сущность экзаменатора<a class="headerlink" href="#id25" title="Link to this heading"></a></h4>
<p>Далее необходимо определить класс
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.Examiner" title="lab_4_fill_words_by_ngrams.main.Examiner"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.Examiner</span></code></a>,
роль которого заключается в осуществлении логики составления и оценки
экзамена.</p>
<p>С интерфейсом инициализации экземпляра данного класса, а также с составом
требуемых атрибутов можно ознакомиться в соответствующей строке документации
в файле <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p>
<p>Обратите внимание, что экземпляры данного класса
имеют атрибут, заполнение которого нужно произвести в момент инициализации
при помощи метода, который вы реализуете на следующем шаге.</p>
<p>Пример инициализации экземпляра:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">examiner</span> <span class="o">=</span> <span class="n">Examiner</span><span class="p">(</span><span class="s1">&#39;./assets/question_and_answers.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id26">
<h4>Шаг 5.2. Загрузить вопросы и ответы<a class="headerlink" href="#id26" title="Link to this heading"></a></h4>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.Examiner._load_from_json" title="lab_4_fill_words_by_ngrams.main.Examiner._load_from_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.Examiner._load_from_json()</span></code></a>,
в котором происходит чтение файла из соответствующего атрибута и заполнение
атрибутов его содержимым.</p>
<p>Файл с вопросами и ответами имеет следующую структуру:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
 <span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;Thank very much.&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="s2">&quot;Thank you very much.&quot;</span><span class="p">},</span>
 <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Путь к файлу: <code class="docutils literal notranslate"><span class="pre">assets/questions_and_answers.json</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если путь к файлу не является строкой, либо строка пустая или не
заканчивается как <code class="docutils literal notranslate"><span class="pre">.json</span></code>,
а также если содержимое файла не является списком,
необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
</section>
<section id="id27">
<h4>Шаг 5.3. Вывести вопросы<a class="headerlink" href="#id27" title="Link to this heading"></a></h4>
<p>Экзаменатору известны как вопросы, так и ответы.
Однако при проведении экзамена необходимо делиться только вопросами, именно
поэтому соответствующий атрибут класса экзаменатора является защищенным.</p>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.Examiner.provide_questions" title="lab_4_fill_words_by_ngrams.main.Examiner.provide_questions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.Examiner.provide_questions()</span></code></a>,
возвращающий вопросы экзамена. Метод не должен возвращать ответы!</p>
</section>
<section id="id28">
<h4>Шаг 5.4. Выставить оценку<a class="headerlink" href="#id28" title="Link to this heading"></a></h4>
<p>Реализуйте метод
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.Examiner.assess_exam" title="lab_4_fill_words_by_ngrams.main.Examiner.assess_exam"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.Examiner.assess_exam()</span></code></a>,
заключающий логику проверки ответов.</p>
<p>Метод должен сопоставить полученные ответы с правильными и посчитать долю правильных ответов.
Правильным ответом считается строка, полностью совпадающая с эталоном.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если входной аргумент не является словарем либо словарь пустой,
необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
</section>
<section id="id29">
<h4>Шаг 5.5. Объявить сущность студента<a class="headerlink" href="#id29" title="Link to this heading"></a></h4>
<p>Далее необходимо определить класс
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent" title="lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent"><code class="xref py py-class docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent</span></code></a>.
Данный класс представляет абстракцию студента и реализует общую логику ответа
на вопрос одной из изученных техник генерации.</p>
<p>С интерфейсом инициализации экземпляра данного класса, а также с составом
требуемых атрибутов можно ознакомиться в соответствующей строке документации
в файле <code class="docutils literal notranslate"><span class="pre">main.py</span></code>.</p>
<p>В случае, если атрибут с экземпляром генератора заполняется <strong>Beam Search</strong> алгоритмом,
используйте значение параметра ширины луча <code class="docutils literal notranslate"><span class="pre">5</span></code> при инициализации.
В случае, если атрибут с экземпляром генератора заполняется <strong>Top P</strong> алгоритмом,
используйте значение параметра <strong>P</strong> равное <code class="docutils literal notranslate"><span class="pre">0.5</span></code>.</p>
<p>Пример инициализации экземпляра:</p>
<blockquote>
<div><div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">top_p_student</span> <span class="o">=</span> <span class="n">GeneratorRuleStudent</span><span class="p">(</span><span class="n">generators_types</span><span class="o">.</span><span class="n">top_p</span><span class="p">,</span> <span class="n">language_model</span><span class="p">,</span> <span class="n">word_processor</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id30">
<h4>Шаг 5.6. Составить ответы на задания<a class="headerlink" href="#id30" title="Link to this heading"></a></h4>
<p>Логику обработки заданий необходимо реализовать в методе
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent.take_exam" title="lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent.take_exam"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent.take_exam()</span></code></a>.</p>
<p>Для каждого из заданий метод осуществляет следующие действия:</p>
<ol class="arabic simple">
<li><p>Из последовательности извлекается левый контекст до указанной позиции.</p></li>
<li><p>По выделенному контексту генерируется новая последовательность длины 1.</p></li>
<li><p>Сгенерированная последовательность объединяется с правым контекстом.</p></li>
</ol>
<p>Обратите внимание, что если сгенерированная последовательность заканчивается точкой,
то точку нужно исключить из предсказания.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Если входной аргумент не является списком либо список пустой,
либо если используемые методы возвращают <cite>None</cite>,
необходимо поднять исключение <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
</div>
</section>
<section id="id31">
<h4>Шаг 5.7. Запросить тип алгоритма заполнения<a class="headerlink" href="#id31" title="Link to this heading"></a></h4>
<p>Перед началом сдачи экзамена каждому студенту необходимо представиться.
Для этого реализуйте метод,
возвращающий тип использованного алгоритма генерации,
<a class="reference internal" href="lab_4_fill_words_by_ngrams.api.html#lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent.get_generator_type" title="lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent.get_generator_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lab_4_fill_words_by_ngrams.main.GeneratorRuleStudent.get_generator_type()</span></code></a>.</p>
<p>В данном методе необходимо инициализировать и использовать экземпляр класса <cite>GeneratorTypes</cite>.</p>
<p>Если был использован жадный алгоритм, то следует вернуть строку <code class="docutils literal notranslate"><span class="pre">'greedy</span> <span class="pre">generator'</span></code>,
если <strong>Top P</strong> алгоритм - <code class="docutils literal notranslate"><span class="pre">'top-p</span> <span class="pre">generator'</span></code>,
если <strong>Beam Search</strong> алгоритм - <code class="docutils literal notranslate"><span class="pre">'beam</span> <span class="pre">search</span> <span class="pre">generator'</span></code>.</p>
</section>
<section id="id32">
<h4>Шаг 5.8. Продемонстрировать работу реализации в <code class="docutils literal notranslate"><span class="pre">start.py</span></code><a class="headerlink" href="#id32" title="Link to this heading"></a></h4>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Выполнение Шага 5 соответствует 10 баллам.</p>
</div>
<p>Продемонстрируйте проведение экзамена, создав экземпляр экзаменатора и экземпляры
студентов для каждого из реализованных алгоритмов.</p>
<p>В качестве заданий используйте набор вопросов и ответов из файла
<code class="docutils literal notranslate"><span class="pre">assets/questions_and_answers.json</span></code>.</p>
</section>
</section>
</section>
<section id="id33">
<h2>Полезные ссылки<a class="headerlink" href="#id33" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://huggingface.co/blog/how-to-generate#top-p-nucleus-sampling">Top P алгоритм генерации</a></p></li>
<li><p><a class="reference external" href="https://huggingface.co/docs/transformers/perplexity">Perplexity metric</a></p></li>
<li><p><a class="reference external" href="https://www.baeldung.com/java-dto-pattern">DTO (Data Transfer Object)</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../lab_3_generate_by_ngrams/lab_3_generate_by_ngrams.api.html" class="btn btn-neutral float-left" title="lab_3_generate_by_ngrams package" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="lab_4_fill_words_by_ngrams.api.html" class="btn btn-neutral float-right" title="lab_4_fill_words_by_ngrams package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Демидовский А.В. и другие.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>